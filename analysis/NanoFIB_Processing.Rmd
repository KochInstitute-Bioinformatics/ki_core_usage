---
title: "NanoFIB - Data Cleaning, Summary, and Visualizations"
author: "Charlie Whittaker"
output: 
  html_document:
    toc: true
    toc_depth: 4
  html_notebook: default
date: "2/20/2026"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = TRUE,
  warning = TRUE,
  error = TRUE,
  cache = TRUE,
  cache.lazy = FALSE,
  fig.retina = 2
)

# For bioinformatics (Seurat, parallel)
options(future.globals.maxSize = 8e10)

# Optional: seed for reproducibility
set.seed(42)
```

```{r}
library(openxlsx)
library(tidyverse)
library(ggrepel)
library(ggpubr)
library(purrr)
library(knitr)
library(lubridate)
library(patchwork)
```

# Data Import

## Read in ilabs stock data and select Biopolymers rows

```{r}
ilabs <- read.xlsx("../data/stock_ilabs.xlsx")
ilabs.nano <- ilabs %>% dplyr::filter(Core.Name %in% c("Nanotechnology Materials Core "))
rm(ilabs)
```

### Repair ilabs date

```{r}
ilabs.nano$Purchase.Date <- as.Date(ilabs.nano$Purchase.Date, origin = "1899-12-30")
```

### Check dates before range selection

```{r, fig.width=12,fig.height=5}
ilabs.nano %>%
  mutate(Year_Month = floor_date(Purchase.Date, "month")) %>%
  count(Year_Month) %>%
  arrange(Year_Month) %>%
  ggplot(aes(x = Year_Month, y = n)) +
  geom_col(fill = "steelblue") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  labs(title = "Records by Month",
       x = "Month",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Select reporting date range

```{r}
cat("Dimensions of ilabs.nano before reporting range selection:", dim(ilabs.nano), "\n")
ilabs.nano <- ilabs.nano %>% dplyr::filter(between(Purchase.Date, as.Date("2020-05-01"), as.Date("2025-10-31")))
cat("Dimensions of ilabs.nano after reporting range selection:", dim(ilabs.nano), "\n")
```

### Check dates after reporting range selection

```{r, fig.width=12,fig.height=5}
ilabs.nano %>%
  mutate(Year_Month = floor_date(Purchase.Date, "month")) %>%
  count(Year_Month) %>%
  arrange(Year_Month) %>%
  ggplot(aes(x = Year_Month, y = n)) +
  geom_col(fill = "steelblue") +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  labs(title = "Records by Month",
       x = "Month",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# Faculty Annotation Work

### Import faculty key data

```{r}
fac.key <- read.xlsx("../data/FacultyKeys.xlsx")
```

### Associate Faculty.Key with ilabs.nano

```{r}
ilabs.nano <- ilabs.nano %>%
  left_join(fac.key %>%
              select(ValueInData, Faculty.Key) %>%
              distinct(), 
            by = c("Customer.Lab" = "ValueInData"))
```

### Import sponsor annotation data

```{r}
fac.annot <- read.xlsx("../data/annotated.Faculty.Keys.xlsx")
```

### Join sponsorship to ilabs.nano using Faculty.Key

```{r}
ilabs.nano <- ilabs.nano %>%
  dplyr::left_join(
    fac.annot %>% dplyr::select(Faculty.Key, NanoFIB_Sponsor),
    by = "Faculty.Key"
  )
```

### Simplify sponsor associations for plotting

#### Import simplified categories

```{r}
sponsor.toPlot <- read.xlsx("../data/sponsor.Keys.ForPlotting.xlsx")
sponsor.toPlot
```

#### Join simplified sponsor data to ilabs.nano

```{r}
ilabs.nano <- ilabs.nano %>%
  dplyr::left_join(sponsor.toPlot, by = c("NanoFIB_Sponsor" = "Sponsor"))
```

# Service Annotation

Exclude usage.type = unknown
Exclude usage.type = N/A and Category = "DLS/Spectradyne charges"

# Data Visualizations

## Define Colors

```{r}
# Define colors for each Sponsor (adjust these hex codes as needed)
sponsor_colors <- c(
  "Center_Member" = "steelblue",
  "MIT_Sponsor" = "lightpink",
  "Non_Sponsor" = "orange"
)

# Define order of sponsors for stacking (top to bottom)
sponsor_order <- c("Center_Member", "MIT_Sponsor", "Non_Sponsor")
```

## Pie Charts

### Instrument Use: Assisted or Training

Include usage.type that includes "assisted", "training" or "unattended"
Include usage.type = N/A and Category = "SEM/FIB/Airyscan charges"
Include usage.type = N/A and Category = "Technical Time" and Charge.Name contains "Training",
Include usage.type = N/A and Category = TEM/Cryo-TEM charges and Charge.Name does NOT include "Sample" or "Cryoplunging"


```{r}
train.1 <- ilabs.nano %>% dplyr::filter(str_detect(Usage.Type, "Assisted|Training|Unattended"))
cat("Rows train1:", dim(train.1)[1], "\n")
train.2 <- ilabs.nano %>% dplyr::filter(Usage.Type == "N/A" & Category == "SEM/FIB/Airyscan charges")
cat("Rows train2:", dim(train.2)[1], "\n")
train.3 <- ilabs.nano %>% dplyr::filter(Usage.Type == "N/A" & Category == "Technical Time" & str_detect(Charge.Name, "Training"))
cat("Rows train3:", dim(train.3)[1], "\n")
train.4 <- ilabs.nano %>% dplyr::filter(Usage.Type == "N/A" & 
                                          Category == "TEM/Cryo-TEM charges" & 
                                          !str_detect(Charge.Name, "Cryoplunging") & 
                                          !str_detect(Charge.Name, regex("Sample",ignore_case = TRUE)))
cat("Rows train4:", dim(train.4)[1], "\n")
```

#### Combine the train objects

```{r}
train <- rbind(train.1,train.2,train.3,train.4)
```

### Prepare Instrument Use: Assisted or Training pie chart

```{r}
train.pie <- train %>%
  mutate(Sponsor_ForPlot = factor(Sponsor_ForPlot, levels = sponsor_order)) %>%
  group_by(Sponsor_ForPlot) %>%
  summarise(Quantity = sum(Quantity), 
            Num_Labs = if_else(first(Sponsor_ForPlot) == "Center_Member",
                               n_distinct(Faculty.Key[NanoFIB_Sponsor == "KI_member"]),
                               n_distinct(Faculty.Key)),
            .groups = "drop") %>%
  mutate(Percent = round((Quantity / sum(Quantity)) * 100, 0),
         Lab_Label = if_else(Sponsor_ForPlot == "Center_Member",
                             paste0(Num_Labs, " Members"),
                             paste0(Num_Labs, " Users")),
         Label = paste0(Quantity, "\n", Percent, "%\n", Lab_Label)) %>%
  ggplot(aes(x = "", y = Quantity, fill = Sponsor_ForPlot)) +
  geom_col() +
  geom_text(aes(label = Label), 
            position = position_stack(vjust = 0.5),
            size = 3,
            fontface = "bold",
            color = "white") +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = sponsor_colors) +
  labs(title = "Instrument Use: Assisted or Training Hours",
       fill = "Sponsor") +
  theme_void() +
  theme(legend.position = "right")

train.pie
```

### Instrument Use: Trained

Include usage.type that includes "independent" or "trained",

```{r}
trained.use <- ilabs.nano %>% dplyr::filter(str_detect(Usage.Type, "Independent|Trained"))
cat("trained.use Rows:", dim(trained.use)[1], "\n")
```

#### Check the data

```{r}
as.data.frame(table(trained.use$Usage.Type))
```

### Prepare Instrument Use: Trained pie chart

```{r}
trained.use.pie <- trained.use %>%
  mutate(Sponsor_ForPlot = factor(Sponsor_ForPlot, levels = sponsor_order)) %>%
  group_by(Sponsor_ForPlot) %>%
  summarise(Quantity = sum(Quantity), 
            Num_Labs = if_else(first(Sponsor_ForPlot) == "Center_Member",
                               n_distinct(Faculty.Key[NanoFIB_Sponsor == "KI_member"]),
                               n_distinct(Faculty.Key)),
            .groups = "drop") %>%
  mutate(Percent = round((Quantity / sum(Quantity)) * 100, 0),
         Lab_Label = if_else(Sponsor_ForPlot == "Center_Member",
                             paste0(Num_Labs, " Members"),
                             paste0(Num_Labs, " Users")),
         Label = paste0(Quantity, "\n", Percent, "%\n", Lab_Label)) %>%
  ggplot(aes(x = "", y = Quantity, fill = Sponsor_ForPlot)) +
  geom_col() +
  geom_text(aes(label = Label), 
            position = position_stack(vjust = 0.5),
            size = 3,
            fontface = "bold",
            color = "white") +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = sponsor_colors) +
  labs(title = "Instrument Use: Trained Hours",
       fill = "Sponsor") +
  theme_void() +
  theme(legend.position = "right")

trained.use.pie
```

### EM Sample Preparation

Include usage.type = N/A and Category = "EM Sample Prep" if Charge.Name not in ("Autogrid Clip", "Gold TEM Grid", "HPF: LN2", "HPF: Planchet")
Include usage.type = N/A and Category = "Technical Time" and Charge.Name contains "Technical Time",
Include usage.type = N/A and Category = "TEM/Cryo-TEM charges" and Charge.Name in "Sample" or "Cryoplunging"

```{r}
sample.1 <- ilabs.nano %>% dplyr::filter(Usage.Type == "N/A" & Category == "EM Sample Prep") %>% 
  dplyr::filter(!Charge.Name %in% c("Autogrid Clip", "Gold TEM Grid", "HPF: LN2", "HPF: Planchet"))
cat("Rows sample.1:", dim(sample.1)[1], "\n")
sample.2 <- ilabs.nano %>% dplyr::filter(Usage.Type == "N/A" & Category == "Technical Time") %>% 
  dplyr::filter(str_detect(Charge.Name, regex("Technical Time",ignore_case = TRUE)))
cat("Rows sample.2:", dim(sample.2)[1], "\n")
sample.3 <- ilabs.nano %>% dplyr::filter(Usage.Type == "N/A" & Category == "TEM/Cryo-TEM charges" & str_detect(Charge.Name, regex("Sample|Cryoplunging",ignore_case = TRUE)))
cat("Rows sample.3:", dim(sample.3)[1], "\n")
```

#### Combine the data

```{r}
sample <- rbind(sample.1,sample.2,sample.3)
```

### Prepare Instrument Use: Trained pie chart

```{r}
sample.pie <- sample %>%
  mutate(Sponsor_ForPlot = factor(Sponsor_ForPlot, levels = sponsor_order)) %>%
  group_by(Sponsor_ForPlot) %>%
  summarise(Quantity = sum(Quantity), 
            Num_Labs = if_else(first(Sponsor_ForPlot) == "Center_Member",
                               n_distinct(Faculty.Key[NanoFIB_Sponsor == "KI_member"]),
                               n_distinct(Faculty.Key)),
            .groups = "drop") %>%
  mutate(Percent = round((Quantity / sum(Quantity)) * 100, 0),
         Lab_Label = if_else(Sponsor_ForPlot == "Center_Member",
                             paste0(Num_Labs, " Members"),
                             paste0(Num_Labs, " Users")),
         Label = paste0(Quantity, "\n", Percent, "%\n", Lab_Label)) %>%
  ggplot(aes(x = "", y = Quantity, fill = Sponsor_ForPlot)) +
  geom_col() +
  geom_text(aes(label = Label), 
            position = position_stack(vjust = 0.5),
            size = 3,
            fontface = "bold",
            color = "white") +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = sponsor_colors) +
  labs(title = "EM Sample Preparation Units",
       fill = "Sponsor") +
  theme_void() +
  theme(legend.position = "right")

sample.pie
```

# Plot the pie charts figure

```{r,fig.width=16,fig.height=4}
trained.use.pie + train.pie + sample.pie + plot_layout(ncol = 3, guides = "collect")

combo.pie <- trained.use.pie + train.pie + sample.pie + plot_layout(ncol = 3, guides = "collect")
ggsave("figures/NanoFIB_combo.pie.pdf", 
       plot = combo.pie, 
       dpi = 150, 
       width = 16, 
       height = 4, 
       units = "in")
```


# Write annotated output file

```{r}
write.xlsx(ilabs.nano,"nano.final.xlsx")
```

# write session info

Capturing information about the R session helps document your work

```{r}
sessionInfo()
writeLines(capture.output(sessionInfo()), "TPSI_processing_sessionInfo.txt")
```
